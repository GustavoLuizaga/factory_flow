[gd_scene load_steps=2 format=3 uid="uid://bvaja8b5djo73"]

[sub_resource type="GDScript" id="GDScript_f8hfj"]
script/source = "extends Control
class_name ProfilePanel

# Referencias a los nodos de la UI
@onready var login_container: VBoxContainer    = $ColorRect/Panel/VBoxContainer/LoginContainer
@onready var register_container: VBoxContainer = $ColorRect/Panel/VBoxContainer/RegisterContainer
@onready var login_username: LineEdit      = $ColorRect/Panel/VBoxContainer/LoginContainer/LoginUsername
@onready var login_password: LineEdit  = $ColorRect/Panel/VBoxContainer/LoginContainer/LoginPassword
@onready var register_fullname: LineEdit         = $ColorRect/Panel/VBoxContainer/RegisterContainer/RegisterFullname
@onready var register_username: LineEdit   = $ColorRect/Panel/VBoxContainer/RegisterContainer/RegisterUsername
@onready var register_password: LineEdit         = $ColorRect/Panel/VBoxContainer/RegisterContainer/RegisterPassword
@onready var register_confirm_password: LineEdit = $ColorRect/Panel/VBoxContainer/RegisterContainer/RegisterConfirmPassword

@onready var error_label: Label            = $ColorRect/Panel/VBoxContainer/ErrorLabel

func _ready() -> void:
	# El panel empieza oculto
	visible = false
	_show_login()

# -------------------------
# Métodos para abrir el panel
# -------------------------

# El menú llamará a esto: mode = \"login\" o \"register\"
func open_as(mode: String) -> void:
	visible = true
	get_tree().paused = true
	error_label.text = \"\"

	if mode == \"login\":
		_show_login()
	else:
		_show_register()

func _show_login() -> void:
	login_container.visible = true
	register_container.visible = false

func _show_register() -> void:
	login_container.visible = false
	register_container.visible = true

# -------------------------
# Callbacks de botones
# (conecta en el editor)
# -------------------------

func _on_login_tab_button_pressed() -> void:
	_show_login()

func _on_register_tab_button_pressed() -> void:
	_show_register()

func _on_close_button_pressed() -> void:
	visible = false
	get_tree().paused = false

func _on_login_button_pressed() -> void:
	# Leemos usuario y contraseña desde los LineEdit
	var username: String = login_username.text.strip_edges()
	var password: String = login_password.text

	# Validación básica
	if username == \"\" or password == \"\":
		error_label.text = \"Ingresa usuario y contraseña.\"
		return

	# Llamamos al ProgressManager con (username, password)
	var ok: bool = ProgressManager.login(username, password)

	if not ok:
		error_label.text = \"Usuario o contraseña incorrectos.\"
		return

	# Si todo va bien, cerramos el panel
	_on_close_button_pressed()

func _on_register_button_pressed() -> void:
	# Leemos los datos del formulario de registro
	var full_name: String = register_fullname.text.strip_edges()
	var username: String = register_username.text.strip_edges()
	var password: String = register_password.text
	var confirm: String = register_confirm_password.text

	# Validación básica
	if full_name == \"\" or username == \"\" or password == \"\" or confirm == \"\":
		error_label.text = \"Completa todos los campos.\"
		return
	if password != confirm:
		error_label.text = \"Las contraseñas no coinciden.\"
		return
		
	# Registrar usuario en ProgressManager
	var ok: bool = ProgressManager.register_user(full_name, username, password)
	if not ok:
		error_label.text = \"El usuario ya existe o los datos no son válidos.\"
		return

	# Si todo bien, cerramos el panel
	_on_close_button_pressed()
"

[node name="ProfilePanel" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_f8hfj")

[node name="ColorRect" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0, 0, 0, 0.19607843)

[node name="Panel" type="Panel" parent="ColorRect"]
custom_minimum_size = Vector2(600, 400)
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -20.0
offset_top = -20.0
offset_right = 20.0
offset_bottom = 20.0
grow_horizontal = 2
grow_vertical = 2

[node name="VBoxContainer" type="VBoxContainer" parent="ColorRect/Panel"]
layout_mode = 1
anchors_preset = 14
anchor_top = 0.5
anchor_right = 1.0
anchor_bottom = 0.5
offset_top = -179.0
offset_bottom = 179.0
grow_horizontal = 2
grow_vertical = 2

[node name="Label" type="Label" parent="ColorRect/Panel/VBoxContainer"]
layout_mode = 2

[node name="VBoxContainer2" type="VBoxContainer" parent="ColorRect/Panel/VBoxContainer"]
layout_mode = 2

[node name="IniciarSesion" type="Button" parent="ColorRect/Panel/VBoxContainer/VBoxContainer2"]
layout_mode = 2

[node name="Registrarse" type="Button" parent="ColorRect/Panel/VBoxContainer/VBoxContainer2"]
layout_mode = 2

[node name="LoginContainer" type="VBoxContainer" parent="ColorRect/Panel/VBoxContainer"]
layout_mode = 2

[node name="Usuario" type="Label" parent="ColorRect/Panel/VBoxContainer/LoginContainer"]
layout_mode = 2

[node name="LoginUsername" type="LineEdit" parent="ColorRect/Panel/VBoxContainer/LoginContainer"]
layout_mode = 2

[node name="Entrar" type="Button" parent="ColorRect/Panel/VBoxContainer/LoginContainer"]
layout_mode = 2

[node name="RegisterContainer" type="VBoxContainer" parent="ColorRect/Panel/VBoxContainer"]
layout_mode = 2

[node name="Usuario" type="Label" parent="ColorRect/Panel/VBoxContainer/RegisterContainer"]
layout_mode = 2

[node name="RegisterUsername" type="LineEdit" parent="ColorRect/Panel/VBoxContainer/RegisterContainer"]
layout_mode = 2

[node name="Edad" type="Label" parent="ColorRect/Panel/VBoxContainer/RegisterContainer"]
layout_mode = 2

[node name="RegisterAge" type="LineEdit" parent="ColorRect/Panel/VBoxContainer/RegisterContainer"]
layout_mode = 2

[node name="Colegio" type="Label" parent="ColorRect/Panel/VBoxContainer/RegisterContainer"]
layout_mode = 2

[node name="RegisterSchool" type="LineEdit" parent="ColorRect/Panel/VBoxContainer/RegisterContainer"]
layout_mode = 2

[node name="Crear perfil" type="Button" parent="ColorRect/Panel/VBoxContainer/RegisterContainer"]
layout_mode = 2

[node name="ErrorLabel" type="Label" parent="ColorRect/Panel/VBoxContainer"]
layout_mode = 2

[node name="Cerrar" type="Button" parent="ColorRect/Panel/VBoxContainer"]
layout_mode = 2

[connection signal="pressed" from="ColorRect/Panel/VBoxContainer/VBoxContainer2/IniciarSesion" to="ColorRect/Panel/VBoxContainer/VBoxContainer2/IniciarSesion" method="_on_login_tab_button_pressed"]
[connection signal="pressed" from="ColorRect/Panel/VBoxContainer/VBoxContainer2/Registrarse" to="ColorRect/Panel/VBoxContainer/VBoxContainer2/IniciarSesion" method="_on_register_tab_button_pressed"]
[connection signal="pressed" from="ColorRect/Panel/VBoxContainer/LoginContainer/Entrar" to="ColorRect/Panel/VBoxContainer/VBoxContainer2/IniciarSesion" method="_on_login_button_pressed"]
[connection signal="pressed" from="ColorRect/Panel/VBoxContainer/RegisterContainer/Crear perfil" to="ColorRect/Panel/VBoxContainer/VBoxContainer2/IniciarSesion" method="_on_register_button_pressed"]
[connection signal="pressed" from="ColorRect/Panel/VBoxContainer/Cerrar" to="ColorRect/Panel/VBoxContainer/VBoxContainer2/IniciarSesion" method="_on_close_button_pressed"]
